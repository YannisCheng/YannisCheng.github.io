<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,蓝牙," />










<meta name="description" content="参考文章：https://www.jianshu.com/p/3a372af38103参考文章：https://www.jianshu.com/p/29a730795294android developers：https://developer.android.google.cn/guide/topics/connectivity/bluetooth-le.html#terms部分图片来源：ht">
<meta name="keywords" content="Android,蓝牙">
<meta property="og:type" content="article">
<meta property="og:title" content="Android BLE 蓝牙开发">
<meta property="og:url" content="http://yannischeng.com/Android BLE 蓝牙开发/index.html">
<meta property="og:site_name" content="YannisCheng&#39;s Technology Blogs">
<meta property="og:description" content="参考文章：https://www.jianshu.com/p/3a372af38103参考文章：https://www.jianshu.com/p/29a730795294android developers：https://developer.android.google.cn/guide/topics/connectivity/bluetooth-le.html#terms部分图片来源：ht">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-06%2009.29.46.png">
<meta property="og:image" content="http://oy991qm3u.bkt.clouddn.com/4985212-4eb4addccb3fe853.png">
<meta property="og:image" content="http://oy991qm3u.bkt.clouddn.com/1806858-265d374ad9bb425f.png">
<meta property="og:image" content="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-02%2010.10.05.png">
<meta property="og:image" content="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-02%2010.11.50.png">
<meta property="og:updated_time" content="2018-07-08T08:22:05.103Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android BLE 蓝牙开发">
<meta name="twitter:description" content="参考文章：https://www.jianshu.com/p/3a372af38103参考文章：https://www.jianshu.com/p/29a730795294android developers：https://developer.android.google.cn/guide/topics/connectivity/bluetooth-le.html#terms部分图片来源：ht">
<meta name="twitter:image" content="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-06%2009.29.46.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yannischeng.com/Android BLE 蓝牙开发/"/>





  <title>Android BLE 蓝牙开发 | YannisCheng's Technology Blogs</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">YannisCheng's Technology Blogs</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">不必一味的讨好别人，每个人都有自己的活法。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yannischeng.com/Android BLE 蓝牙开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="YannisCheng">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://oy991qm3u.bkt.clouddn.com/%E6%A2%B5%E9%AB%98.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="YannisCheng's Technology Blogs">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android BLE 蓝牙开发</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-01T22:17:04+08:00">
                2018-02-01
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-07-08T16:22:05+08:00">
                2018-07-08
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4,628 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  19 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    

    
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/蓝牙/" rel="tag"># 蓝牙</a>
          
        </div>
      

    
    
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    YannisCheng
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://yannischeng.com/Android BLE 蓝牙开发/" title="Android BLE 蓝牙开发">http://yannischeng.com/Android BLE 蓝牙开发/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    尊重个人劳动成果，转载请注明出处。 ─=≡Σ(((つ•̀ω•́)つ))
  </li>
</ul>

      </div>
    



    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <blockquote>
<p>参考文章：<a href="https://www.jianshu.com/p/3a372af38103" target="_blank" rel="external">https://www.jianshu.com/p/3a372af38103</a><br>参考文章：<a href="https://www.jianshu.com/p/29a730795294" target="_blank" rel="external">https://www.jianshu.com/p/29a730795294</a><br>android developers：<a href="https://developer.android.google.cn/guide/topics/connectivity/bluetooth-le.html#terms" target="_blank" rel="external">https://developer.android.google.cn/guide/topics/connectivity/bluetooth-le.html#terms</a><br>部分图片来源：<a href="https://www.youtube.com/watch?v=vUbFB1Qypg8" target="_blank" rel="external">https://www.youtube.com/watch?v=vUbFB1Qypg8</a><br>经典蓝牙使用参考：<a href="http://blog.csdn.net/axinmeng88/article/details/79059468" target="_blank" rel="external">http://blog.csdn.net/axinmeng88/article/details/79059468</a><br>BLE设备地址参考：<a href="http://www.wowotech.net/bluetooth/ble_address_type.html" target="_blank" rel="external">http://www.wowotech.net/bluetooth/ble_address_type.html</a></p>
</blockquote>
<a id="more"></a>
<h1 id="蓝牙唯一身份标识"><a href="#蓝牙唯一身份标识" class="headerlink" title="蓝牙唯一身份标识"></a>蓝牙唯一身份标识</h1><ul>
<li><strong>MAC地址</strong>：这个地址是唯一的，就像网络上的<strong>IP地址</strong></li>
</ul>
<p><img src="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-06%2009.29.46.png" alt=""></p>
<p><strong>UUID（Universally Unique Identifier）</strong>：可以把它理解为是IP地址中的<strong>端口号</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">更多UUID接口参考：https://www.jianshu.com/p/3de46c75f8ce，</div><div class="line">官网：https://www.bluetooth.com/zh-cn/specifications/assigned-numbers/service-discovery</div></pre></td></tr></table></figure>
<p><strong>MAC + UUID = IP地址 + 端口号</strong>。这两者合起来就是蓝牙的唯一身份标识。BLE扫描的过程，设备会生成随机地址。根据随机地址也能进行连接。</p>
<h1 id="BLE-Bluetooth-Low-Energy-低功耗蓝牙"><a href="#BLE-Bluetooth-Low-Energy-低功耗蓝牙" class="headerlink" title="BLE (Bluetooth Low Energy) 低功耗蓝牙"></a>BLE (Bluetooth Low Energy) 低功耗蓝牙</h1><p>Android 4.3（API级别18）引入了以低功耗蓝牙（BLE）为中心角色的内置平台支持，并提供应用程序可用于发现设备，查询服务和传输信息的API</p>
<p>常见用例包括以下内容：</p>
<ul>
<li>在附近的设备之间传输少量的数据</li>
<li>与Google Beacons等接近传感器进行互动，为用户提供基于当前位置的定制体验。</li>
</ul>
<p>传统蓝牙可以用于数据量比较大的传输，如语音，音乐，较高数据量传输等，但是比较耗电，低功耗蓝牙这样应用于实时性要求比较高，功耗比较低，但是数据速率比较低的产品，如遥控类的，如鼠标，键盘，遥控鼠标(Air Mouse)，传感设备的数据发送，如心跳带，血压计，温度传感器等。</p>
<h1 id="关键术语（Key-Terms）和-概念（Concepts）"><a href="#关键术语（Key-Terms）和-概念（Concepts）" class="headerlink" title="关键术语（Key Terms）和 概念（Concepts）"></a>关键术语（Key Terms）和 概念（Concepts）</h1><p><img src="http://oy991qm3u.bkt.clouddn.com/4985212-4eb4addccb3fe853.png" alt=""></p>
<p>GATT图示1</p>
<p><img src="http://oy991qm3u.bkt.clouddn.com/1806858-265d374ad9bb425f.png" alt=""></p>
<p>GATT图示2</p>
<ul>
<li><p><strong>通用属性配置文件 Generic Attribute Profile（GATT）</strong>：GATT配置文件是通过BLE链接发送和接收被称为“属性”的短小数据的通用规范。目前所有的低能耗应用程序都基于GATT。</p>
<ul>
<li>蓝牙SIG为低能耗设备定义了许多配置文件。 配置文件是设备如何在特定应用程序中工作的规范。 请注意，设备可以实现多个配置文件。 例如，一个设备可以包含一个心率监测器和一个电池电量检测器。</li>
<li><p>你可以把他看成xml来理解：</p>
<ul>
<li>每个GATT由完成不同功能的Service组成；</li>
<li>每个Service由不同的Characteristic组成；</li>
<li><p>每个Characteristic由一个value和一个或者多个Descriptor组成；</p>
<p>Service、Characteristic相当于标签（Service相当于他的类别，Characteristic相当于它的名字），而value才真正的包含数据，Descriptor是对这个value进行的说明和描述，当然我们可以从不同角度来描述和说明，因此可以有多个Descriptor.</p>
<p><strong>举一个简单的例子进行说明：</strong></p>
<p>常见的小米手环是一个BLE设备，（假设）它包含三个Service,分别是提供设备信息的Service、提供步数的Service、检测心率的Service;<br>而设备信息的service中包含的characteristic包括厂商信息、硬件信息、版本信息等；而心率Service则包括心率characteristic等，而心率characteristic中的value则真正的包含心率的数据，而descriptor则是对该value的描述说明，比如value的单位啊，描述啊，权限啊等。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>属性协议 Attribute Protocol（ATT）</strong>：GATT建立在属性协议（ATT）之上。 这也被称为GATT / ATT。 ATT经过优化，可在BLE设备上运行。 为此，它使用尽可能少的字节。 每个属性由一个<strong>通用唯一标识符（UUID）</strong>唯一标识，该标识符是用于唯一标识信息的字符串ID的标准化128位格式。 ATT传输的属性被格式化为特征和服务。</li>
<li><strong>特性 Characteristic</strong>： 特性包含描述特性值的单个值和0-n个描述符。一个特征可以被认为是一个类，类似于一个阶级。是最小的数据逻辑单元。</li>
<li><strong>描述符 Descriptor</strong>： 描述符是描述特征值的定义属性。 例如，一个描述符可以指定一个可读的描述，一个特征值的可接受范围，或者一个特征值特有的度量单位。value、descriptor中存储数据的解析由Server的工程师决定，并无规范，双发按照约定开发。</li>
<li><strong>服务 Service</strong>： 服务是一个特征的集合。 例如，您可以拥有一个名为“心率监测器”的服务，其中包含“心率测量”等特性。 您可以在bluetooth.org上找到现有基于GATT的配置文件和服务的列表。Service/Characteristic均有一个<strong>唯一的UUID标识</strong>，UUID既有<strong>16位</strong>的也有<strong>128位</strong>的，我们需要了解的是16位的UUID是经过蓝牙组织认证的，是需要购买的，当然也有一些通用的16位UUID。例如<strong>Heart Rate</strong>服务的UUID就是0X180D,代码中表示为0X00001800-0000-1000-8000-00805f9b34fb,其他位为固定的。而128位的UUID则可以自定义。</li>
</ul>
<h1 id="角色（Roles）和责任（Responsibilities）"><a href="#角色（Roles）和责任（Responsibilities）" class="headerlink" title="角色（Roles）和责任（Responsibilities）"></a>角色（Roles）和责任（Responsibilities）</h1><p>以下是Android设备与BLE设备交互时适用的角色和职责：</p>
<ul>
<li><strong>中央（Central）</strong> 与 <strong>周边（Peripheral）</strong>。这适用于BLE连接本身。处于中心角色的设备扫描，寻找广告，并且在外围角色中的设备进行广告。</li>
<li><strong>GATT服务器</strong> 与 <strong>GATT客户端</strong>。这决定了两台设备在建立连接后如何相互通话。</li>
</ul>
<p><img src="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-02%2010.10.05.png" alt=""></p>
<p>为了理解这个区别，假设你有一个Android手机和一个BLE设备的活动追踪器。 手机支持中心角色; 活动跟踪器支持外设角色（建立一个BLE连接，你需要每两个事物中只有一个支持外围设备的人不能彼此交谈，也不能只支持两个事物）。</p>
<p>一旦手机和活动追踪器建立了连接，他们就开始将GATT元数据转移到另一个。根据他们传输的数据的种类，其中一个或另一个可能充当服务器。例如，如果活动跟踪器想要将传感器数据报告给电话，则活动跟踪器可以充当服务器。如果活动跟踪器想要从手机接收更新，那么手机作为服务器可能是有意义的。</p>
<p>在本文档中使用的示例中，Android应用程序（在Android设备上运行）是GATT客户端。该应用程序从GATT服务器获取数据，GATT服务器是支持心率档案的BLE心率监测器。但你也可以设计你的Android应用程序来扮演GATT服务器的角色。有关更多信息，请参阅BluetoothGattServer。</p>
<h1 id="BLE-权限（Permissions）"><a href="#BLE-权限（Permissions）" class="headerlink" title="BLE 权限（Permissions）"></a>BLE 权限（Permissions）</h1><ul>
<li><p>为了在您的应用程序中使用蓝牙功能，您必须声明（declare） <strong>权限1：BLUETOOTH</strong>。您需要此权限才能执行（perform）任何 <strong>蓝牙通信</strong> ，例如 请求连接，接受连接以及传输数据。</p>
</li>
<li><p>如果您希望您的应用启动设备<strong>发现或操纵（manipulate）蓝牙设置</strong>，则还必须声明 <strong>权限2：BLUETOOTH_ADMIN</strong>。 注意：如果您使用BLUETOOTH_ADMIN权限，则还必须具有BLUETOOTH权限。</p>
</li>
</ul>
<p>在应用程序清单文件中声明蓝牙许可。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;uses-permission android:name=&quot;android.permission.BLUETOOTH&quot;/&gt;</div><div class="line">&lt;uses-permission android:name=&quot;android.permission.BLUETOOTH_ADMIN&quot;/&gt;</div></pre></td></tr></table></figure>
<p>如果您想声明您的应用<strong>仅适用于具有BLE功能的设备</strong>，请在应用的清单中包含以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;uses-feature android:name=&quot;android.hardware.bluetooth_le&quot; android:required=&quot;true&quot;/&gt;</div></pre></td></tr></table></figure>
<p>但是，如果您想让您的应用可用于不支持BLE的设备，则应该在应用的清单中包含此元素，但设置<code>required =“false”</code>。 然后在运行时，您可以使用<code>PackageManager.hasSystemFeature（）</code>来确定BLE可用性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// Use this check to determine whether BLE is supported on the device. Then</div><div class="line">// you can selectively disable BLE-related features.</div><div class="line">if (!getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) &#123;</div><div class="line">    Toast.makeText(this, R.string.ble_not_supported, Toast.LENGTH_SHORT).show();</div><div class="line">    finish();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意：</strong><br>LE信标往往与<strong>位置</strong>有关。 为了在没有过滤器的情况下使用<strong>BluetoothLeScanner</strong>，您<strong>必须</strong>通过在应用的清单文件中声明</p>
<ul>
<li><strong>权限3：ACCESS_COARSE_LOCATION</strong> </li>
</ul>
<p>或</p>
<ul>
<li><strong>权限3：ACCESS_FINE_LOCATION</strong></li>
</ul>
<p>权限来请求用户的许可。 <strong>没有这些权限，扫描将不会返回任何结果</strong>。</p>
<h1 id="设置BLE"><a href="#设置BLE" class="headerlink" title="设置BLE"></a>设置BLE</h1><p>在您的应用程序可以通过BLE进行通信之前，您需要验证设备是否支持BLE，如果是，请确保已启用BLE。请注意，只有在<uses-feature ...="">设置为false时才需要执行此项检查</uses-feature></p>
<p>如果不支持BLE，那么您应该禁用任何BLE功能。<br>如果BLE支持，但被禁用，那么您可以请求用户启用蓝牙，而无需离开您的应用程序。 使用<strong>BluetoothAdapter</strong>，可以分两步完成此设置：</p>
<h2 id="1-获取-BluetoothAdapter"><a href="#1-获取-BluetoothAdapter" class="headerlink" title="1. 获取 BluetoothAdapter"></a>1. 获取 BluetoothAdapter</h2><p>BluetoothAdapter是任何和所有的蓝牙活动所必需的。 BluetoothAdapter代表<strong>设备自己的蓝牙适配器</strong>（蓝牙无线电）。整个系统有一个蓝牙适配器，您的应用程序可以<strong>使用这个对象与它进行交互</strong>。下面的代码展示了如何获取适配器。请注意，此方法使用getSystemService（）返回BluetoothManager的实例，然后用于获取适配器。 Android 4.3（API Level 18）介绍了BluetoothManager：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private BluetoothAdapter mBluetoothAdapter;</div><div class="line">...</div><div class="line">// Initializes Bluetooth adapter.</div><div class="line">final BluetoothManager bluetoothManager =</div><div class="line">        (BluetoothManager) getSystemService(Context.BLUETOOTH_SERVICE);</div><div class="line">mBluetoothAdapter = bluetoothManager.getAdapter();</div></pre></td></tr></table></figure>
<h2 id="2-启用蓝牙"><a href="#2-启用蓝牙" class="headerlink" title="2. 启用蓝牙"></a>2. 启用蓝牙</h2><p>接下来，您需要确保蓝牙已启用。调用<strong>isEnabled（）</strong>来检查当前是否启用了蓝牙。如果此方法返回false，则蓝牙被禁用。以下片段检查是否启用了蓝牙。如果不是，该片段会显示一个错误，提示用户转到设置以启用蓝牙：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// Ensures Bluetooth is available on the device and it is enabled. If not,</div><div class="line">// displays a dialog requesting user permission to enable Bluetooth.</div><div class="line">if (mBluetoothAdapter == null || !mBluetoothAdapter.isEnabled()) &#123;</div><div class="line">    Intent enableBtIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</div><div class="line">    startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注意：</strong><br>传递给 startActivityForResult（android.content.Intent，int）的<strong>REQUEST_ENABLE_BT</strong>常量是系统在onActivityResult（int，int，android.content）中返回给您的本地定义的整数（它必须大于0））实现作为requestCode参数。</p>
<h1 id="查找BLE设备"><a href="#查找BLE设备" class="headerlink" title="查找BLE设备"></a>查找BLE设备</h1><p>要查找BLE设备，请使用<strong>startLeScan（）</strong>方法。 此方法将<strong>BluetoothAdapter.LeScanCallback</strong>作为参数。 您必须实现此<strong>BluetoothAdapter.LeScanCallback</strong>，因为这是如何<strong>返回扫描结果</strong>。 由于扫描耗电量大，您应遵守以下准则:</p>
<ul>
<li>一旦找到所需的设备，请停止扫描</li>
<li>切勿扫描循环，并在扫描上设置时间限制。以前可用的设备可能已移出范围，并继续扫描电池电量。</li>
</ul>
<p>以下片段显示了如何<strong>启动</strong>和<strong>停止</strong>扫描：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Activity for scanning and displaying available BLE devices.</div><div class="line"> */</div><div class="line">public class DeviceScanActivity extends ListActivity &#123;</div><div class="line"></div><div class="line">    private BluetoothAdapter mBluetoothAdapter;</div><div class="line">    private boolean mScanning;</div><div class="line">    private Handler mHandler;</div><div class="line"></div><div class="line">    // Stops scanning after 10 seconds.</div><div class="line">    private static final long SCAN_PERIOD = 10000;</div><div class="line">    ...</div><div class="line">    private void scanLeDevice(final boolean enable) &#123;</div><div class="line">        if (enable) &#123;</div><div class="line">            // Stops scanning after a pre-defined scan period.</div><div class="line">            mHandler.postDelayed(new Runnable() &#123;</div><div class="line">                @Override</div><div class="line">                public void run() &#123;</div><div class="line">                    mScanning = false;</div><div class="line">                    mBluetoothAdapter.stopLeScan(mLeScanCallback);</div><div class="line">                &#125;</div><div class="line">            &#125;, SCAN_PERIOD);</div><div class="line"></div><div class="line">            mScanning = true;</div><div class="line">            mBluetoothAdapter.startLeScan(mLeScanCallback);</div><div class="line">        &#125; else &#123;</div><div class="line">            mScanning = false;</div><div class="line">            mBluetoothAdapter.stopLeScan(mLeScanCallback);</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果只想扫描特定类型的外设，则改为调用<strong>startLeScan（UUID []，BluetoothAdapter.LeScanCallback）</strong>，提供<strong>指定</strong>您的应用程序支持的GATT服务的UUID对象数组。</p>
<p>以下是<strong>BluetoothAdapter.LeScanCallback</strong>的一个实现，它是用于<strong>传递BLE扫描结果</strong>的接口🤔：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">private LeDeviceListAdapter mLeDeviceListAdapter;</div><div class="line">...</div><div class="line">// Device scan callback.</div><div class="line">private BluetoothAdapter.LeScanCallback mLeScanCallback =</div><div class="line">        new BluetoothAdapter.LeScanCallback() &#123;</div><div class="line">    @Override</div><div class="line">    public void onLeScan(final BluetoothDevice device, int rssi,</div><div class="line">            byte[] scanRecord) &#123;</div><div class="line">        runOnUiThread(new Runnable() &#123;</div><div class="line">           @Override</div><div class="line">           public void run() &#123;</div><div class="line">               mLeDeviceListAdapter.addDevice(device);</div><div class="line">               mLeDeviceListAdapter.notifyDataSetChanged();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：<br>您<strong>只能</strong>扫描蓝牙LE设备或扫描经典蓝牙设备，如蓝牙中所述。您<strong>无法同时</strong>扫描Bluetooth LE和传统设备。</p>
<h1 id="连接到GATT服务器（发送数据的BLE设备）"><a href="#连接到GATT服务器（发送数据的BLE设备）" class="headerlink" title="连接到GATT服务器（发送数据的BLE设备）"></a>连接到GATT服务器（发送数据的BLE设备）</h1><p><img src="http://oy991qm3u.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-02-02%2010.11.50.png" alt=""></p>
<p>与BLE设备交互的<strong>第一步是连接到它</strong>，更具体地说，连接到设备上的GATT服务器。 要连接到BLE设备上的GATT服务器，请使用<strong>connectGatt（）</strong>方法。 此方法有三个参数：一个<strong>Context</strong>对象，<strong>autoConnect</strong>（布尔值，指示<strong>是否</strong>在BLE设备<strong>变为可用时自动连接</strong>）以及对<strong>BluetoothGattCallback</strong>的引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mBluetoothGatt = device.connectGatt(this, false, mGattCallback);</div></pre></td></tr></table></figure>
<p>这将连接到由BLE设备托管的GATT服务器，并返回一个BluetoothGatt实例，然后您可以使用该实例来执行GATT客户端操作。 调用者（Android应用程序）是GATT客户端。 BluetoothGattCallback用于向客户端传递结果，例如连接状态，以及任何其他GATT客户端操作</p>
<p>在这个例子中，BLE应用程序提供了一个Activity（DeviceControlActivity）来连接，显示数据，并显示设备支持的GATT服务和特性。 根据用户输入，此Activity与一个名为BluetoothLeService的服务进行通信，该服务通过Android BLE API与BLE设备进行交互：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">// A service that interacts with the BLE device via the Android BLE API.</div><div class="line">public class BluetoothLeService extends Service &#123;</div><div class="line">    private final static String TAG = BluetoothLeService.class.getSimpleName();</div><div class="line"></div><div class="line">    private BluetoothManager mBluetoothManager;</div><div class="line">    private BluetoothAdapter mBluetoothAdapter;</div><div class="line">    private String mBluetoothDeviceAddress;</div><div class="line">    private BluetoothGatt mBluetoothGatt;</div><div class="line">    private int mConnectionState = STATE_DISCONNECTED;</div><div class="line"></div><div class="line">    private static final int STATE_DISCONNECTED = 0;</div><div class="line">    private static final int STATE_CONNECTING = 1;</div><div class="line">    private static final int STATE_CONNECTED = 2;</div><div class="line"></div><div class="line">    public final static String ACTION_GATT_CONNECTED =</div><div class="line">            &quot;com.example.bluetooth.le.ACTION_GATT_CONNECTED&quot;;</div><div class="line">    public final static String ACTION_GATT_DISCONNECTED =</div><div class="line">            &quot;com.example.bluetooth.le.ACTION_GATT_DISCONNECTED&quot;;</div><div class="line">    public final static String ACTION_GATT_SERVICES_DISCOVERED =</div><div class="line">            &quot;com.example.bluetooth.le.ACTION_GATT_SERVICES_DISCOVERED&quot;;</div><div class="line">    public final static String ACTION_DATA_AVAILABLE =</div><div class="line">            &quot;com.example.bluetooth.le.ACTION_DATA_AVAILABLE&quot;;</div><div class="line">    public final static String EXTRA_DATA =</div><div class="line">            &quot;com.example.bluetooth.le.EXTRA_DATA&quot;;</div><div class="line"></div><div class="line">    public final static UUID UUID_HEART_RATE_MEASUREMENT =</div><div class="line">            UUID.fromString(SampleGattAttributes.HEART_RATE_MEASUREMENT);</div><div class="line"></div><div class="line">    // Various callback methods defined by the BLE API.</div><div class="line">    private final BluetoothGattCallback mGattCallback =</div><div class="line">            new BluetoothGattCallback() &#123;</div><div class="line">        @Override</div><div class="line">        public void onConnectionStateChange(BluetoothGatt gatt, int status,</div><div class="line">                int newState) &#123;</div><div class="line">            String intentAction;</div><div class="line">            if (newState == BluetoothProfile.STATE_CONNECTED) &#123;</div><div class="line">                intentAction = ACTION_GATT_CONNECTED;</div><div class="line">                mConnectionState = STATE_CONNECTED;</div><div class="line">                broadcastUpdate(intentAction);</div><div class="line">                Log.i(TAG, &quot;Connected to GATT server.&quot;);</div><div class="line">                Log.i(TAG, &quot;Attempting to start service discovery:&quot; +</div><div class="line">                        mBluetoothGatt.discoverServices());</div><div class="line"></div><div class="line">            &#125; else if (newState == BluetoothProfile.STATE_DISCONNECTED) &#123;</div><div class="line">                intentAction = ACTION_GATT_DISCONNECTED;</div><div class="line">                mConnectionState = STATE_DISCONNECTED;</div><div class="line">                Log.i(TAG, &quot;Disconnected from GATT server.&quot;);</div><div class="line">                broadcastUpdate(intentAction);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        // New services discovered</div><div class="line">        public void onServicesDiscovered(BluetoothGatt gatt, int status) &#123;</div><div class="line">            if (status == BluetoothGatt.GATT_SUCCESS) &#123;</div><div class="line">                broadcastUpdate(ACTION_GATT_SERVICES_DISCOVERED);</div><div class="line">            &#125; else &#123;</div><div class="line">                Log.w(TAG, &quot;onServicesDiscovered received: &quot; + status);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        // Result of a characteristic read operation</div><div class="line">        public void onCharacteristicRead(BluetoothGatt gatt,</div><div class="line">                BluetoothGattCharacteristic characteristic,</div><div class="line">                int status) &#123;</div><div class="line">            if (status == BluetoothGatt.GATT_SUCCESS) &#123;</div><div class="line">                broadcastUpdate(ACTION_DATA_AVAILABLE, characteristic);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">     ...</div><div class="line">    &#125;;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当一个特定的回调被触发时，它会调用相应的broadcastUpdate（）辅助方法并传递一个动作。 请注意，本节中的数据解析是根据蓝牙心率测量配置文件规范执行的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">private void broadcastUpdate(final String action) &#123;</div><div class="line">    final Intent intent = new Intent(action);</div><div class="line">    sendBroadcast(intent);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void broadcastUpdate(final String action,</div><div class="line">                             final BluetoothGattCharacteristic characteristic) &#123;</div><div class="line">    final Intent intent = new Intent(action);</div><div class="line"></div><div class="line">    // This is special handling for the Heart Rate Measurement profile. Data</div><div class="line">    // parsing is carried out as per profile specifications.</div><div class="line">    if (UUID_HEART_RATE_MEASUREMENT.equals(characteristic.getUuid())) &#123;</div><div class="line">        int flag = characteristic.getProperties();</div><div class="line">        int format = -1;</div><div class="line">        if ((flag &amp; 0x01) != 0) &#123;</div><div class="line">            format = BluetoothGattCharacteristic.FORMAT_UINT16;</div><div class="line">            Log.d(TAG, &quot;Heart rate format UINT16.&quot;);</div><div class="line">        &#125; else &#123;</div><div class="line">            format = BluetoothGattCharacteristic.FORMAT_UINT8;</div><div class="line">            Log.d(TAG, &quot;Heart rate format UINT8.&quot;);</div><div class="line">        &#125;</div><div class="line">        final int heartRate = characteristic.getIntValue(format, 1);</div><div class="line">        Log.d(TAG, String.format(&quot;Received heart rate: %d&quot;, heartRate));</div><div class="line">        intent.putExtra(EXTRA_DATA, String.valueOf(heartRate));</div><div class="line">    &#125; else &#123;</div><div class="line">        // For all other profiles, writes the data formatted in HEX.</div><div class="line">        final byte[] data = characteristic.getValue();</div><div class="line">        if (data != null &amp;&amp; data.length &gt; 0) &#123;</div><div class="line">            final StringBuilder stringBuilder = new StringBuilder(data.length);</div><div class="line">            for(byte byteChar : data)</div><div class="line">                stringBuilder.append(String.format(&quot;%02X &quot;, byteChar));</div><div class="line">            intent.putExtra(EXTRA_DATA, new String(data) + &quot;\n&quot; +</div><div class="line">                    stringBuilder.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    sendBroadcast(intent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>回到DeviceControlActivity中，这些事件由BroadcastReceiver处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// Handles various events fired by the Service.</div><div class="line">// ACTION_GATT_CONNECTED: connected to a GATT server.</div><div class="line">// ACTION_GATT_DISCONNECTED: disconnected from a GATT server.</div><div class="line">// ACTION_GATT_SERVICES_DISCOVERED: discovered GATT services.</div><div class="line">// ACTION_DATA_AVAILABLE: received data from the device. This can be a</div><div class="line">// result of read or notification operations.</div><div class="line">private final BroadcastReceiver mGattUpdateReceiver = new BroadcastReceiver() &#123;</div><div class="line">    @Override</div><div class="line">    public void onReceive(Context context, Intent intent) &#123;</div><div class="line">        final String action = intent.getAction();</div><div class="line">        if (BluetoothLeService.ACTION_GATT_CONNECTED.equals(action)) &#123;</div><div class="line">            mConnected = true;</div><div class="line">            updateConnectionState(R.string.connected);</div><div class="line">            invalidateOptionsMenu();</div><div class="line">        &#125; else if (BluetoothLeService.ACTION_GATT_DISCONNECTED.equals(action)) &#123;</div><div class="line">            mConnected = false;</div><div class="line">            updateConnectionState(R.string.disconnected);</div><div class="line">            invalidateOptionsMenu();</div><div class="line">            clearUI();</div><div class="line">        &#125; else if (BluetoothLeService.</div><div class="line">                ACTION_GATT_SERVICES_DISCOVERED.equals(action)) &#123;</div><div class="line">            // Show all the supported services and characteristics on the</div><div class="line">            // user interface.</div><div class="line">            displayGattServices(mBluetoothLeService.getSupportedGattServices());</div><div class="line">        &#125; else if (BluetoothLeService.ACTION_DATA_AVAILABLE.equals(action)) &#123;</div><div class="line">            displayData(intent.getStringExtra(BluetoothLeService.EXTRA_DATA));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="读取BLE属性"><a href="#读取BLE属性" class="headerlink" title="读取BLE属性"></a>读取BLE属性</h1><p>一旦你的Android应用程序连接到GATT服务器并发现服务，它就可以在支持的地方读取和写入属性。例如，这个代码片段遍历服务器的服务和特性，并在UI中显示它们：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">public class DeviceControlActivity extends Activity &#123;</div><div class="line">    ...</div><div class="line">    // （演示）Demonstrates how to （遍历）iterate through the supported GATT</div><div class="line">    // Services/Characteristics.</div><div class="line">    // In this sample, we （填充）populate the data structure that is bound to the</div><div class="line">    // ExpandableListView on the UI.</div><div class="line">    private void displayGattServices(List&lt;BluetoothGattService&gt; gattServices) &#123;</div><div class="line">        if (gattServices == null) return;</div><div class="line">        String uuid = null;</div><div class="line">        String unknownServiceString = getResources().</div><div class="line">                getString(R.string.unknown_service);</div><div class="line">        String unknownCharaString = getResources().</div><div class="line">                getString(R.string.unknown_characteristic);</div><div class="line">        ArrayList&lt;HashMap&lt;String, String&gt;&gt; gattServiceData =</div><div class="line">                new ArrayList&lt;HashMap&lt;String, String&gt;&gt;();</div><div class="line">        ArrayList&lt;ArrayList&lt;HashMap&lt;String, String&gt;&gt;&gt; gattCharacteristicData</div><div class="line">                = new ArrayList&lt;ArrayList&lt;HashMap&lt;String, String&gt;&gt;&gt;();</div><div class="line">        mGattCharacteristics =</div><div class="line">                new ArrayList&lt;ArrayList&lt;BluetoothGattCharacteristic&gt;&gt;();</div><div class="line"></div><div class="line">        // Loops through available GATT Services.</div><div class="line">        for (BluetoothGattService gattService : gattServices) &#123;</div><div class="line">            HashMap&lt;String, String&gt; currentServiceData =</div><div class="line">                    new HashMap&lt;String, String&gt;();</div><div class="line">            uuid = gattService.getUuid().toString();</div><div class="line">            currentServiceData.put(</div><div class="line">                    LIST_NAME, SampleGattAttributes.</div><div class="line">                            lookup(uuid, unknownServiceString));</div><div class="line">            currentServiceData.put(LIST_UUID, uuid);</div><div class="line">            gattServiceData.add(currentServiceData);</div><div class="line"></div><div class="line">            ArrayList&lt;HashMap&lt;String, String&gt;&gt; gattCharacteristicGroupData =</div><div class="line">                    new ArrayList&lt;HashMap&lt;String, String&gt;&gt;();</div><div class="line">            List&lt;BluetoothGattCharacteristic&gt; gattCharacteristics =</div><div class="line">                    gattService.getCharacteristics();</div><div class="line">            ArrayList&lt;BluetoothGattCharacteristic&gt; charas =</div><div class="line">                    new ArrayList&lt;BluetoothGattCharacteristic&gt;();</div><div class="line">           // Loops through available Characteristics.</div><div class="line">            for (BluetoothGattCharacteristic gattCharacteristic :</div><div class="line">                    gattCharacteristics) &#123;</div><div class="line">                charas.add(gattCharacteristic);</div><div class="line">                HashMap&lt;String, String&gt; currentCharaData =</div><div class="line">                        new HashMap&lt;String, String&gt;();</div><div class="line">                uuid = gattCharacteristic.getUuid().toString();</div><div class="line">                currentCharaData.put(</div><div class="line">                        LIST_NAME, SampleGattAttributes.lookup(uuid,</div><div class="line">                                unknownCharaString));</div><div class="line">                currentCharaData.put(LIST_UUID, uuid);</div><div class="line">                gattCharacteristicGroupData.add(currentCharaData);</div><div class="line">            &#125;</div><div class="line">            mGattCharacteristics.add(charas);</div><div class="line">            gattCharacteristicData.add(gattCharacteristicGroupData);</div><div class="line">         &#125;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="接收GATT通知"><a href="#接收GATT通知" class="headerlink" title="接收GATT通知"></a>接收GATT通知</h1><p>BLE应用程序<strong>在设备上发生特定特征变化时</strong>要求收到通知是很常见的。这段代码展示了如何使用setCharacteristicNotification（）方法为特性<strong>设置通知</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">private BluetoothGatt mBluetoothGatt;</div><div class="line">BluetoothGattCharacteristic characteristic;</div><div class="line">boolean enabled;</div><div class="line">...</div><div class="line">mBluetoothGatt.setCharacteristicNotification(characteristic, enabled);</div><div class="line">...</div><div class="line">BluetoothGattDescriptor descriptor = characteristic.getDescriptor(</div><div class="line">        UUID.fromString(SampleGattAttributes.CLIENT_CHARACTERISTIC_CONFIG));</div><div class="line">descriptor.setValue(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE);</div><div class="line">mBluetoothGatt.writeDescriptor(descriptor);</div></pre></td></tr></table></figure>
<p>一旦为特征启用了通知，如果特性在远程设备上发生变化，则会触发onCharacteristicChanged（）回调：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">// Characteristic notification</div><div class="line">public void onCharacteristicChanged(BluetoothGatt gatt,</div><div class="line">        BluetoothGattCharacteristic characteristic) &#123;</div><div class="line">    broadcastUpdate(ACTION_DATA_AVAILABLE, characteristic);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="关闭客户端App"><a href="#关闭客户端App" class="headerlink" title="关闭客户端App"></a>关闭客户端App</h1><p>一旦您的应用程序使用BLE设备，应该调用close（），以便系统可以正确释放资源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public void close() &#123;</div><div class="line">    if (mBluetoothGatt == null) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    mBluetoothGatt.close();</div><div class="line">    mBluetoothGatt = null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Android-BLE-API"><a href="#Android-BLE-API" class="headerlink" title="Android BLE API"></a>Android BLE API</h1><h2 id="BluetoothAdapter"><a href="#BluetoothAdapter" class="headerlink" title="BluetoothAdapter"></a>BluetoothAdapter</h2><p>代表本地设备蓝牙适配器。 BluetoothAdapter允许您<strong>执行基本的蓝牙任务</strong>，例如启动设备发现，查询绑定（配对）设备列表，使用已知的MAC地址实例化BluetoothDevice，并创建BluetoothServerSocket以侦听来自其他设备的连接请求，并启动扫描蓝牙LE设备。</p>
<p>要获得代表本地蓝牙适配器的BluetoothAdapter，请在<strong>BluetoothManager</strong>上调用getAdapter（）函数。在JELLY_BEAN_MR1和下面，您将需要使用静态getDefaultAdapter（）方法。</p>
<p>从根本上说，这<strong>是所有蓝牙操作的起点</strong>。一旦你有了本地适配器，你就可以用getBondedDevices（）获得一组代表所有配对设备的BluetoothDevice对象。用startDiscovery（）启动设备发现;或者用listenUsingRfcommWithServiceRecord（String，UUID）创建一个BluetoothServerSocket监听传入的连接请求;或使用startLeScan（LeScanCallback）开始扫描蓝牙LE设备。</p>
<p><strong>注：</strong><br>大多数方法需要<strong>BLUETOOTH</strong>权限，有些还需要<strong>BLUETOOTH_ADMIN</strong>权限。</p>
<p><strong>BluetoothAdapter.LeScanCallback</strong>：用于提供LE扫描结果的回调接口。</p>
<h2 id="BluetoothManager"><a href="#BluetoothManager" class="headerlink" title="BluetoothManager"></a>BluetoothManager</h2><p>用于获取BluetoothAdapter的实例并进行整体蓝牙管理。使用带有BLUETOOTH_SERVICE的getSystemService（java.lang.String）来创建一个BluetoothManager，然后调用getAdapter（）来获得BluetoothAdapter</p>
<h2 id="BluetoothGatt"><a href="#BluetoothGatt" class="headerlink" title="BluetoothGatt"></a>BluetoothGatt</h2><p>蓝牙GATT配置文件的公共API。</p>
<p>本class提供蓝牙GATT功能，以实现与Bluetooth Smart或Smart Ready设备的通信。</p>
<p>要连接到远程外围设备，请创建一个BluetoothGattCallback并调用connectGatt（Context，boolean，BluetoothGattCallback）来获取此类的一个实例。 使用蓝牙设备发现或BLE扫描过程可以发现支持GATT的设备。</p>
<h2 id="BluetoothGattCallback"><a href="#BluetoothGattCallback" class="headerlink" title="BluetoothGattCallback"></a>BluetoothGattCallback</h2><p>这个抽象类的作用是实现<strong>BluetoothGatt</strong>的回调。</p>
<h2 id="BluetoothGattCharacteristic"><a href="#BluetoothGattCharacteristic" class="headerlink" title="BluetoothGattCharacteristic"></a>BluetoothGattCharacteristic</h2><p>代表蓝牙GATT特性。GATT特性是用于构建GATT服务的<strong>基本数据元素</strong>，BluetoothGattService。 该特性包含一个值以及附加信息和可选的GATT描述符BluetoothGattDescriptor。</p>
<h2 id="BluetoothGattService"><a href="#BluetoothGattService" class="headerlink" title="BluetoothGattService"></a>BluetoothGattService</h2><p>代表一个蓝牙GATT服务。Gatt服务包含一系列BluetoothGattCharacteristic以及引用的服务。</p>
<h2 id="BluetoothGattDescriptor"><a href="#BluetoothGattDescriptor" class="headerlink" title="BluetoothGattDescriptor"></a>BluetoothGattDescriptor</h2><p>代表一个蓝牙GATT描述符.GATT描述符包含GATT特性的<strong>附加信息</strong>和<strong>属性</strong>，BluetoothGattCharacteristic。 它们可以用来描述特征的特征或控制特征的某些行为。</p>

      
    </div>
    
    
    

    

    


    <footer class="post-footer">
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/Python3-Scrapy爬取地址5级联动数据 - 初级/" rel="next" title="Python3-Scrapy爬取地址5级联动数据 - 初级">
                <i class="fa fa-chevron-left"></i> Python3-Scrapy爬取地址5级联动数据 - 初级
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Android传统蓝牙开发/" rel="prev" title="Android传统蓝牙开发">
                Android传统蓝牙开发 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://oy991qm3u.bkt.clouddn.com/%E6%A2%B5%E9%AB%98.gif"
                alt="YannisCheng" />
            
              <p class="site-author-name" itemprop="name">YannisCheng</p>
              <p class="site-description motion-element" itemprop="description">不必一味的讨好别人，每个人都有自己的活法。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">104</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/YannisCheng" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:cwj1714@163.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#蓝牙唯一身份标识"><span class="nav-number">1.</span> <span class="nav-text">蓝牙唯一身份标识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BLE-Bluetooth-Low-Energy-低功耗蓝牙"><span class="nav-number">2.</span> <span class="nav-text">BLE (Bluetooth Low Energy) 低功耗蓝牙</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关键术语（Key-Terms）和-概念（Concepts）"><span class="nav-number">3.</span> <span class="nav-text">关键术语（Key Terms）和 概念（Concepts）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#角色（Roles）和责任（Responsibilities）"><span class="nav-number">4.</span> <span class="nav-text">角色（Roles）和责任（Responsibilities）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BLE-权限（Permissions）"><span class="nav-number">5.</span> <span class="nav-text">BLE 权限（Permissions）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设置BLE"><span class="nav-number">6.</span> <span class="nav-text">设置BLE</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-获取-BluetoothAdapter"><span class="nav-number">6.1.</span> <span class="nav-text">1. 获取 BluetoothAdapter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-启用蓝牙"><span class="nav-number">6.2.</span> <span class="nav-text">2. 启用蓝牙</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查找BLE设备"><span class="nav-number">7.</span> <span class="nav-text">查找BLE设备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#连接到GATT服务器（发送数据的BLE设备）"><span class="nav-number">8.</span> <span class="nav-text">连接到GATT服务器（发送数据的BLE设备）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#读取BLE属性"><span class="nav-number">9.</span> <span class="nav-text">读取BLE属性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#接收GATT通知"><span class="nav-number">10.</span> <span class="nav-text">接收GATT通知</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关闭客户端App"><span class="nav-number">11.</span> <span class="nav-text">关闭客户端App</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-BLE-API"><span class="nav-number">12.</span> <span class="nav-text">Android BLE API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothAdapter"><span class="nav-number">12.1.</span> <span class="nav-text">BluetoothAdapter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothManager"><span class="nav-number">12.2.</span> <span class="nav-text">BluetoothManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothGatt"><span class="nav-number">12.3.</span> <span class="nav-text">BluetoothGatt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothGattCallback"><span class="nav-number">12.4.</span> <span class="nav-text">BluetoothGattCallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothGattCharacteristic"><span class="nav-number">12.5.</span> <span class="nav-text">BluetoothGattCharacteristic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothGattService"><span class="nav-number">12.6.</span> <span class="nav-text">BluetoothGattService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BluetoothGattDescriptor"><span class="nav-number">12.7.</span> <span class="nav-text">BluetoothGattDescriptor</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YannisCheng</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">199.4k</span>
  
</div>













        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
  

  
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script>


  


<script type="text/javascript" color="18,146,19" opacity='0.7' zIndex="-1" count="0" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>

</body>
</html>
